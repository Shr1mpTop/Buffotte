# 批量发送问题修复说明

## 问题描述

用户在 `email_config.json` 中配置了 4 个收件人：
```json
{
  "to_address": [
    "HEZH0014@e.ntu.edu.sg",
    "18280228158@163.com",
    "1662962145@qq.com",
    "2144966026@qq.com"
  ]
}
```

但实际发送时只发送给了第 1 个收件人。

## 问题原因

问题出在 `src/email_sender.py` 的邮件发送代码中：

```python
server.send_message(msg)
```

这种调用方式会让 `send_message()` 自动从邮件头中提取收件人地址。但是，在某些情况下，它可能只会提取第一个地址，或者行为不确定。

## 解决方案

修改为显式传递收件人列表：

```python
server.send_message(msg, from_addr=cfg['from_address'], to_addrs=recipients)
```

通过 `to_addrs` 参数明确指定所有收件人，确保邮件发送给列表中的每一个人。

## 修改的文件

- `src/email_sender.py` - 修改了邮件发送逻辑，添加了显式的 `to_addrs` 参数

## 验证方法

运行以下命令进行测试：

```bash
# 测试配置文件解析
python test_email_config.py

# 测试批量发送（会发送实际邮件）
python test_batch_send.py

# 或者直接测试完整流程
python send_cached_report.py
```

## 预期结果

现在发送邮件时应该显示：

```
📧 准备发送给 4 位收件人:
   1. HEZH0014@e.ntu.edu.sg
   2. 18280228158@163.com
   3. 1662962145@qq.com
   4. 2144966026@qq.com

Email sent successfully to 4 recipient(s): HEZH0014@e.ntu.edu.sg, 18280228158@163.com, 1662962145@qq.com, 2144966026@qq.com
```

所有 4 位收件人都应该收到邮件。

## 注意事项

1. **邮件服务商限制**：
   - 某些邮件服务商（如 QQ 邮箱）对单封邮件的收件人数量有限制
   - 如果收件人过多，可能需要分批发送

2. **发送速度**：
   - 邮件会同时发送给所有收件人
   - 对于大量收件人，考虑添加延迟或分批处理

3. **隐私保护**：
   - 当前实现中，所有收件人都能在邮件头中看到完整的收件人列表
   - 如果需要隐藏收件人信息，应该使用密送（BCC）功能

## 后续改进建议

如果需要更好的批量发送体验，可以考虑：

1. **分批发送**：当收件人超过某个阈值时，自动分批发送
2. **BCC 支持**：添加密送功能，隐藏收件人列表
3. **发送日志**：记录每次发送的详细信息，包括成功/失败的收件人
4. **重试机制**：对发送失败的收件人进行重试

---

修复日期：2025-10-02
