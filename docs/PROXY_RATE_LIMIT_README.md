# 代理池和智能速率限制功能说明

## 概述

在 v0.4.0 中，我们为 Buffotte 爬虫添加了两个重要的新功能：
1. **代理池管理** - 支持代理轮换、健康检查和错误统计
2. **智能速率限制** - 根据 429 错误自动调整并发数，避免被封禁

## 新增功能

### 1. 代理池管理 (ProxyPool)

#### 特性
- **代理轮换**: 自动选择最佳代理进行请求
- **健康检查**: 定期检查代理可用性
- **错误统计**: 跟踪每个代理的成功率和响应时间
- **自动恢复**: 不健康的代理会被自动标记并跳过

#### 配置参数
```json
{
  "enable_proxy_pool": true,           // 启用代理池
  "proxy_file": "./proxy_list.txt",   // 代理文件路径
  "proxy_health_check_interval": 300   // 健康检查间隔(秒)
}
```

#### 代理文件格式
每行一个代理，支持以下格式：
```
http://proxy1.example.com:8080
https://proxy2.example.com:3128
http://username:password@proxy3.example.com:8080
```

### 2. 智能速率限制 (IntelligentRateLimiter)

#### 特性
- **429 自动处理**: 遇到速率限制时自动降低并发数
- **动态调整**: 根据成功率自动恢复并发数
- **指数退避**: 连续错误时增加请求延迟
- **实时监控**: 提供详细的速率限制统计

#### 配置参数
```json
{
  "enable_rate_limiting": true,    // 启用智能速率限制
  "initial_concurrency": 6,       // 初始并发数
  "min_concurrency": 1,           // 最小并发数
  "max_concurrency": 20           // 最大并发数
}
```

#### 工作原理
1. **遇到 429 错误**: 并发数 × 0.7，增加延迟
2. **连续成功请求**: 连续成功 10 次后，并发数 × 1.1
3. **其他错误**: 连续错误 5 次后，并发数 -1
4. **延迟机制**: 根据错误频率动态调整请求间隔

## 使用示例

### 1. 启用智能速率限制（推荐）
```json
{
  "enable_rate_limiting": true,
  "initial_concurrency": 6,
  "min_concurrency": 1,
  "max_concurrency": 15
}
```

### 2. 使用代理池
```json
{
  "enable_proxy_pool": true,
  "proxy_file": "./proxies.txt",
  "proxy_health_check_interval": 300
}
```

### 3. 同时启用两个功能
```json
{
  "enable_proxy_pool": true,
  "enable_rate_limiting": true,
  "proxy_file": "./proxies.txt",
  "initial_concurrency": 8,
  "max_concurrency": 20
}
```

## 运行命令

```bash
# 使用默认配置（启用智能速率限制）
python .\crawler\buff_to_mysql_async.py

# 自定义配置文件
python .\crawler\buff_to_mysql_async.py --config ./my_config.json

# 临时调整参数
python .\crawler\buff_to_mysql_async.py --max-pages 100 --threads 3
```

## 监控和统计

运行结束后，系统会输出详细的统计信息：

### 代理池统计
```
代理池统计信息:
  总代理数: 5
  健康代理数: 4
  总请求数: 1250
  成功请求数: 1180
  失败请求数: 70
  整体成功率: 94.40%
```

### 速率限制统计
```
速率限制器统计信息:
  最终并发数: 8
  当前延迟: 0.5秒
  429限制次数: 3
  总请求数: 1200
  成功率: 96.25%
  详细统计: {'success': 1155, 'rate_limit': 3, 'error_timeout': 42}
```

## 最佳实践

### 1. 智能速率限制
- **建议启用**: 即使不使用代理也应启用，可以有效避免被封
- **初始并发数**: 建议从 6 开始，让系统自动调整
- **最大并发数**: 不要设置过高，15-20 已经足够

### 2. 代理池使用
- **代理质量**: 使用高质量的代理服务商
- **健康检查**: 设置适当的检查间隔（300 秒）
- **代理数量**: 建议至少 5-10 个代理
- **轮换策略**: 系统会自动选择最佳代理

### 3. 组合使用
```json
{
  "threads": 3,                    // 适度的线程数
  "enable_rate_limiting": true,    // 必须启用
  "enable_proxy_pool": true,       // 如果有代理
  "initial_concurrency": 6,        // 保守的初始值
  "max_concurrency": 15,           // 合理的上限
  "proxy_file": "./proxies.txt"    // 代理文件
}
```

## 故障排除

### 1. 代理池问题
- **无可用代理**: 检查代理文件格式和代理有效性
- **代理全部不健康**: 检查网络连接和代理服务商状态
- **健康检查失败**: 确认测试 URL 可访问

### 2. 速率限制问题
- **并发数过低**: 检查是否频繁遇到 429 错误
- **响应过慢**: 可能是并发数设置过高或网络问题
- **频繁降级**: 考虑使用代理池分散请求

### 3. 性能优化
- **线程数 vs 并发数**: 线程数 × 每线程并发数 = 总并发数
- **内存使用**: 过高的并发数会增加内存占用
- **网络带宽**: 确保网络带宽足够支持设定的并发数

## 注意事项

1. **合规使用**: 请遵守目标网站的 robots.txt 和服务条款
2. **速率控制**: 即使有代理池也要控制总体请求频率
3. **监控日志**: 关注 429 错误和代理健康状态
4. **备用方案**: 准备多个代理来源，避免单点故障
5. **成本控制**: 高质量代理通常按流量收费，注意成本控制

## 版本兼容性

- 向后兼容所有 v0.3.x 配置
- 新功能默认关闭（代理池）或智能启用（速率限制）
- 可以单独启用任一功能或组合使用