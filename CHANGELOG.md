# ChangeLog

## [0.4.0] - 2025-09-20

### 🔄 Added - 代理池管理系统
- **ProxyPool类**: 全新的代理池管理器，支持代理轮换和健康检查
- **代理健康监控**: 自动检测代理可用性，记录响应时间和成功率
- **智能代理选择**: 根据成功率和响应时间自动选择最佳代理
- **错误统计**: 详细记录每个代理的成功和失败次数
- **自动恢复**: 不健康的代理会被自动标记并在恢复后重新启用

### 🧠 Added - 智能速率限制系统
- **IntelligentRateLimiter类**: 根据服务器响应自动调整请求频率
- **429错误处理**: 遇到速率限制时自动降低并发数和增加延迟
- **动态恢复**: 连续成功请求后逐步恢复并发数
- **指数退避**: 连续错误时使用指数退避策略
- **实时监控**: 提供详细的速率限制统计信息

### ⚙️ Added - 新配置选项
- **enable_proxy_pool**: 启用/禁用代理池功能
- **enable_rate_limiting**: 启用/禁用智能速率限制（默认启用）
- **initial_concurrency**: 初始并发数设置
- **min_concurrency**: 最小并发数限制
- **max_concurrency**: 最大并发数限制
- **proxy_health_check_interval**: 代理健康检查间隔

### 🛡️ Enhanced - 防封策略
- **多层保护**: 代理池 + 速率限制 + 错误重试的多重保护
- **智能调节**: 根据实际网络状况自动调整爬取策略
- **故障容错**: 代理失效或网络问题时的自动故障转移
- **性能平衡**: 在爬取效率和稳定性之间取得最佳平衡

### 📊 Added - 统计监控
- **代理池统计**: 显示代理健康状态、成功率、请求分布等信息
- **速率限制统计**: 显示429命中次数、并发数变化、成功率等
- **实时反馈**: 爬取过程中显示详细的状态信息和错误统计
- **性能分析**: 提供响应时间、错误类型等性能指标

### 📋 Added - 文档更新
- **PROXY_RATE_LIMIT_README.md**: 详细的代理池和速率限制使用指南
- **配置示例**: 提供多种使用场景的配置示例
- **最佳实践**: 总结代理池和速率限制的最佳实践经验
- **故障排除**: 常见问题和解决方案指南

## [0.3.0] - 2025-09-20

### 📊 Added - 价格历史数据支持
- **价格历史表**: 新增独立的 `items_price_history` 表记录所有价格变化
- **双表设计**: 主表保持最新数据，历史表记录完整价格变化轨迹
- **高效索引**: 为 item_id + recorded_at 组合添加索引，优化查询性能
- **配置控制**: 新增 `enable_price_history` 配置项控制是否启用价格历史
- **环境变量**: `BUFF_ENABLE_PRICE_HISTORY` 环境变量支持

### 🔧 Fixed - 配置系统重要修复
- **配置优先级修复**: 修复命令行参数默认值覆盖config.json的重要问题 ⭐**重要修复**
- **智能参数处理**: 现在只有用户明确指定的命令行参数才会覆盖配置文件
- **配置来源显示**: 运行时显示配置来源和参数覆盖情况，便于调试和验证

All notable changes to this project will be documented in this file.

## [0.3.0] - 2025-09-20

### � Added - 价格历史数据支持
- **价格历史表**: 新增独立的 `items_price_history` 表记录所有价格变化
- **双表设计**: 主表保持最新数据，历史表记录完整价格变化轨迹
- **高效索引**: 为 item_id + recorded_at 组合添加索引，优化查询性能
- **配置控制**: 新增 `enable_price_history` 配置项控制是否启用价格历史
- **环境变量**: `BUFF_ENABLE_PRICE_HISTORY` 环境变量支持

### 🔍 Features - 历史数据分析
- **价格趋势分析**: 支持分析商品价格的长期走势
- **市场波动监控**: 识别价格异常波动的商品
- **投资机会发现**: 找出价格被低估或高估的商品
- **联查询支持**: 提供丰富的 SQL 查询示例
- **数据完整性**: 每次爬取都记录完整的价格快照

### 📖 Documentation
- 新增 `PRICE_HISTORY_README.md` 详细说明价格历史功能
- 提供多种联查询示例：价格趋势、波动分析、投资策略等
- 更新 README.md 包含价格历史功能说明
- 添加数据库结构说明和使用场景

### 🔄 Changed
- 重构 `writer_loop` 函数，支持同时写入主表和历史表
- 更新配置系统，支持价格历史开关
- 优化数据库写入性能，批量处理历史数据
- 增强错误处理，确保历史数据写入的可靠性

### ✨ Compatibility
- **完全向下兼容**: 原有数据结构和功能完全保持
- **渐进式升级**: 可选择性启用价格历史功能
- **性能影响最小**: 历史数据写入与主数据并行处理

## [0.2.0] - 2025-09-20

### 🚀 Added - 多线程异步爬虫
- **多线程支持**: 实现多线程 + 异步并发的双重优化架构
- **智能页面分配**: 自动将页面范围平均分配给各个线程
- **线程安全设计**: 使用 ThreadSafeDataManager 确保数据写入安全
- **新增命令行参数**: `--threads` 参数控制线程数量，`--config` 参数指定配置文件
- **config.json支持**: 新增配置文件支持，优先级：命令行参数 > 环境变量 > config.json > 默认值
- **环境变量支持**: `BUFF_THREADS` 环境变量配置
- **详细监控输出**: 实时显示每个线程的工作进度和状态

### 🚀 Performance
- **性能大幅提升**: 5个线程可实现5倍性能提升（5线程×6并发=30个同时请求）
- **资源优化**: 每个线程使用独立的HTTP客户端和事件循环

### 🔄 Changed
- 重构主函数，支持多线程架构
- 优化数据库写入机制，确保多线程环境下的安全性
- 改进错误处理，单个线程出错不影响其他线程
- 增强配置系统，支持多种配置方式的优先级覆盖

### ✨ Features
- **向下兼容**: 保留原有单线程版本作为备选
- **灵活配置**: 支持1-N个线程的灵活配置
- **智能分工**: 页面范围自动分割，支持不均匀分配
- **配置文件**: 支持JSON配置文件，便于管理复杂配置

### 📖 Documentation
- 更新 README.md 包含多线程使用说明和配置文件说明
- 新增 MULTI_THREAD_README.md 详细说明多线程功能
- 添加性能对比和配置建议
- 完整的命令行参数说明

### 🚀 Performance
- **性能大幅提升**: 5个线程可实现5倍性能提升（5线程×6并发=30个同时请求）
- **资源优化**: 每个线程使用独立的HTTP客户端和事件循环

### 🔄 Changed
- 重构主函数，支持多线程架构
- 优化数据库写入机制，确保多线程环境下的安全性
- 改进错误处理，单个线程出错不影响其他线程
- 增强配置系统，支持多种配置方式的优先级覆盖

### ✨ Features
- **向下兼容**: 保留原有单线程版本作为备选
- **灵活配置**: 支持1-N个线程的灵活配置
- **智能分工**: 页面范围自动分割，支持不均匀分配
- **配置文件**: 支持JSON配置文件，便于管理复杂配置

### 📖 Documentation
- 更新 README.md 包含多线程使用说明和配置文件说明
- 新增 MULTI_THREAD_README.md 详细说明多线程功能
- 添加性能对比和配置建议
- 完整的命令行参数说明

## [0.1.0] - 2025-09-19

### Added
- 基于网站内部 API 批量抓取商品列表数据
- 支持 cookie（登录态）以获取需要登录才能查看的页面
- 异步并发抓取 + 单写入线程批量写入 MySQL
- 支持将抓取结果写入 MySQL（ON DUPLICATE KEY UPDATE 做到幂等写入）
- 环境变量配置支持
- 代理支持